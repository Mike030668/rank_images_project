# docker/tifa/Dockerfile.slim
FROM python:3.10-slim

# ─────────────────── системные пакеты ────────────────────────────────
RUN apt-get update \
 && DEBIAN_FRONTEND=noninteractive \
    apt-get install -y --no-install-recommends \
        build-essential git libgl1 libglib2.0-0 \
 && rm -rf /var/lib/apt/lists/*

# ─────────────────── базовый Python ──────────────────────────────────
RUN pip install --no-cache-dir --upgrade pip==23.3.1 setuptools wheel

# ─────────────────── тяжёлые PyTorch-колёса ──────────────────────────
RUN pip install --no-cache-dir \
        torch==2.2.2+cpu \
        torchvision==0.17.2+cpu \
        -f https://download.pytorch.org/whl/cpu/torch_stable.html

# ─────────────────── лёгкие зависимости ──────────────────────────────
RUN pip install --no-cache-dir \
        "numpy<2" \
        pillow \
        requests \
        tqdm \
        addict \
        packaging \
        filelock \
        pyarrow==14.0.2 \
        datasets==2.13.0 \
        decord==0.6.0 \
        fastapi \
        "uvicorn[standard]" \
        transformers==4.31.0 \
        modelscope==1.9.3

# ─────────────────── проект TIFA ─────────────────────────────────────
WORKDIR /app
COPY external/TIFA /app/TIFA

# вырезаем тяжеловесные зависимости из setup.py
RUN sed -Ei '/(fairseq|streamlit|torchmetrics|kaggle|pandas|evaluate)/d' \
        /app/TIFA/setup.py \
 && pip install --no-cache-dir --no-deps -e /app/TIFA

# ─────────────────── чистка ──────────────────────────────────────────
RUN apt-get purge -y build-essential git \
 && apt-get autoremove -y \
 && rm -rf /root/.cache/pip

# ─────────────────── приложение ─────────────────────────────────────
COPY docker/tifa/app.py /app/app.py
WORKDIR /app
CMD ["uvicorn", "app:api", "--host", "0.0.0.0", "--port", "8000"]
